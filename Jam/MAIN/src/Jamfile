#
# Jamfile to build Jam (a make(1)-like program)
#

# Put executables in platform-specific  subdirectory.
# If $(OSVER) isn't set, second value is used.

LOCATE_TARGET ?= BIN.$(OS)$(OSVER) BIN.$(OS) ;
LOCATE_SOURCE ?= $(LOCATE_TARGET) ;
SEARCH_SOURCE = $(LOCATE_TARGET) $(DOT) ;

#
# We have some different files for UNIX, VMS, and NT.
#

if $(NT) 	{ code = execnt.c filent.c pathunix.c ; } 
else if $(OS2)	{ code = execnt.c fileos2.c pathunix.c ; } 
else if $(VMS) 	{ code = execvms.c filevms.c pathvms.c ; } 
else 		{ code = execunix.c fileunix.c pathunix.c ; }

if $(OS) = NT { CCFLAGS += /DNT ; }
if $(OS) = SOLARIS { CCFLAGS += -Dsolaris ; }

#
# The guts of the Jamfile: how to build Jam
#

Main 		jam : jam.c ;
LinkLibraries 	jam : libjam.a ;

Library         libjam.a : 
		    command.c compile.c $(code) expand.c
		    glob.c hash.c headers.c jambase.c jamgram.y
		    lists.c make.c make1.c newstr.c option.c parse.c
		    regexp.c rules.c scan.c search.c timestamp.c
		    variable.c ;

Main		mkjambase : mkjambase.c ;

#
# How to build the compiled in jambase.
#

rule GenFile 
{
	MakeLocate $(<) : $(LOCATE_SOURCE) ;
	Depends $(<) : $(>[1]:S=$(SUFEXE)) $(>[2]) ;
	GenFile1 $(<) : $(>[1]:S=$(SUFEXE)) $(>[2]) ;
	Clean clean : $(<) ;
}

actions GenFile1
{
	$(>) $(<)
}

GenFile jambase.c : mkjambase Jambase ;

#
# On UNIX, we install this stuff for easy use.
# On VMS, one must define a symbol:  jam :== $jam.exe -f jambase
# On NT, you're on your own.
#

if $(UNIX)
{
	InstallBin $(BINDIR) : jam ;
	InstallMan $(MANDIR) : jam.1 Jambase.5 Jamfile.5 ;
}

#### --- cut

rule YYacc
{
	DEPENDS $(<) : $(>) yyacc ;
	LOCATE on $(<) = $(LOCATE_SOURCE) ;
	Clean clean : $(<) ;
}

actions YYacc
{
	sh yyacc $(>) $(<)
}

if $(UNIX)
{
	YYacc jamgram.y jamgramtab.h : jamgram.yy ;
}

rule TempCopy
{
	DEPENDS $(<) : $(>) ;
}

actions TempCopy
{
	cp $(>) $(<)
}

rule Groff
{
	DEPENDS $(<) : $(>) ;
}

actions Groff
{
	groff -Tps -man $(>) > $(<)
}

ALLSOURCE =
	    README RELNOTES Build.com Jam.paper.ps Jambase Jamfile
	    Jambase.5 Jambase.ps Jamfile.5 Jamfile.ps Makefile
	    Porting command.c command.h compile.c compile.h execcmd.h
	    execnt.c execunix.c execvms.c expand.c expand.h filent.c
	    fileos2.c filesys.h fileunix.c filevms.c glob.c hash.c
	    hash.h headers.c headers.h jam.1 jam.c jam.h jam.ps
	    jambase.c jambase.h jamgram.c jamgram.h jamgram.y
	    jamgramtab.h lists.c lists.h make.c make.h make1.c
	    mkjambase.c newstr.c newstr.h option.c option.h parse.c
	    parse.h patchlevel.h pathunix.c pathvms.c regexp.c
	    regexp.h rules.c rules.h scan.c scan.h search.c search.h
	    timestamp.c timestamp.h variable.c variable.h ;

TempCopy Jam.paper.ps : ../doc/jam.paper.ps ;
Groff jam.ps : jam.1 ;
Groff Jamfile.ps : Jamfile.5 ;
Groff Jambase.ps : Jambase.5 ;

rule Ball
{
	DEPENDS $(<) : $(>) ;

	PreBall $(<) ;

	switch $(<) 
	{
	case *.tar : Tar $(<) : $(>) ;
	case *.shar : Shar $(<) : $(>) ;
	case *.zip : Zip $(<) : $(>) ;
	}

	PostBall $(<) ;

	RmTemps $(<) : Jam.paper.ps ;
}

actions PreBall 
{
	mv Jamfile Jamfile.sav
	sed '/--- cut/,$d' Jamfile.sav > Jamfile
}

actions PostBall 
{
	mv Jamfile.sav Jamfile
}

VERSION = jam-2.1.plus ;

actions Tar
{
	ln -s . $(VERSION)
	tar cvhf $(<) $(VERSION)/$(>)
	rm $(VERSION)
}

actions Shar
{
	shar -l97 -o $(<) $(>) 
}

actions Zip
{
	zip $(<) $(>) 
}

Ball SHAR : $(ALLSOURCE) ;
Ball $(VERSION).tar : $(ALLSOURCE) ;
Ball ZIP : $(ALLSOURCE) ;


